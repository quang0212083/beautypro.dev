Element.implement({tidy:function(){this.set("value",this.get("value").tidy());},getTextInRange:function(c,d){return this.get("value").substring(c,d);},getSelectedText:function(){if(this.setSelectionRange){return this.getTextInRange(this.getSelectionStart(),this.getSelectionEnd());}this.focus();return document.selection.createRange().text;},getSelectedRange:function(){this.focus();if(this.selectionStart!=null){return{start:this.selectionStart,end:this.selectionEnd};}var j={start:0,end:0};var i=this.getDocument().selection.createRange();if(!i||i.parentElement()!=this){return j;}var l=i.duplicate();if(this.type=="text"){j.start=0-l.moveStart("character",-100000);j.end=j.start+i.text.length;}else{var h=this.get("value");var k=h.length;l.moveToElementText(this);l.setEndPoint("StartToEnd",i);if(l.text.length){k-=h.match(/[\n\r]*$/)[0].length;}j.end=k-l.text.length;l.setEndPoint("StartToStart",i);j.start=k-l.text.length;}return j;},getSelectionStart:function(){return this.getSelectedRange().start;},getSelectionEnd:function(){return this.getSelectedRange().end;},setCaretPosition:function(b){if(b=="end"){b=this.get("value").length;}this.selectRange(b,b);return this;},getCaretPosition:function(){return this.getSelectedRange().start;},selectRange:function(j,i){this.focus();if(this.setSelectionRange){this.setSelectionRange(j,i);}else{var l=this.get("value");var k=l.substr(j,i-j).replace(/\r/g,"").length;j=l.substr(0,j).replace(/\r/g,"").length;var h=this.createTextRange();h.collapse(true);h.moveEnd("character",j+k);h.moveStart("character",j);h.select();}return this;},insertAtCursor:function(g,h){var i=this.getSelectedRange();var j=this.get("value");this.set("value",j.substring(0,i.start)+g+j.substring(i.end,j.length));if(h!==false){this.selectRange(i.start,i.start+g.length);}else{this.setCaretPosition(i.start+g.length);}return this;},insertAroundCursor:function(j,k){j=Object.append({before:"",defaultMiddle:"",after:""},j);var p=this.getSelectedText()||j.defaultMiddle;var l=this.getSelectedRange();var m=this.get("value");if(l.start==l.end){this.set("value",m.substring(0,l.start)+j.before+p+j.after+m.substring(l.end,m.length));this.selectRange(l.start+j.before.length,l.end+j.before.length+p.length);}else{var o=m.substring(l.start,l.end);this.set("value",m.substring(0,l.start)+j.before+o+j.after+m.substring(l.end,m.length));var n=l.start+j.before.length;if(k!==false){this.selectRange(n,n+o.length);}else{this.setCaretPosition(n+m.length);}}return this;}});var kbbcode=new Class({Implements:Options,options:{displatchChangeEvent:false,changeEventDelay:1000,interceptTabs:true},initialize:function(d,h,g){this.el=document.id(d);this.selection={start:0,end:0};this.setOptions(g);if(this.options.dispatchChangeEvent){this.el.addEvents({focus:function(a){this.timer=this.watchChange.periodical(this.options.changeEventDelay,this);}.bind(this),blur:function(a){this.timer=clearInterval(this.timer);}.bind(this),select:function(a){this.selection=this.el.getSelectedRange();}.bind(this),click:function(a){this.selection=this.el.getSelectedRange();}.bind(this),keyup:function(a){this.selection=this.el.getSelectedRange();}.bind(this)});}if(this.options.interceptTabs){this.el.addEvent("keypress",function(a){if(a.key=="tab"){a.preventDefault();this.replaceSelection("\t");}}.bind(this));}if(h==null||h==""){h=new Element("li");h.inject(this.el,"before");this.list=h;}else{this.list=document.id(h);}this.oldContent=this.el.get("value");this.list.empty();},watchChange:function(){if(this.oldContent!=this.el.get("value")){this.oldContent=this.el.get("value");this.el.fireEvent("change");}},focus:function(){if(Browser.ie){this.el.selectRange(this.selection.start,this.selection.end);}return this;},getSelection:function(){return this.el.getSelectedText();},wrapSelection:function(h,d,g){g=(g===null)?true:g;this.el.insertAroundCursor({before:h,after:d,defaultMiddle:""});if(!g){this.el.selectRange(this.el.getSelectionEnd(),this.el.getSelectionEnd());}this.selection=this.el.getSelectedRange();},insert:function(j,g,h){h=(h===null)?true:h;var i=(g=="before")?this.el.getSelectionStart():this.el.getSelectionEnd();this.el.selectRange(i,i);this.el.insertAtCursor(j,h);this.selection=this.el.getSelectedRange();},replaceSelection:function(c,d){d=(d===null)?true:d;this.el.insertAtCursor(c,d);this.selection=this.el.getSelectedRange();},processEachLine:function(h){var g=this.el.getSelectedText().split("\n");var d=[];g.each(function(a){if(a.trim()!=""){d.push(h.attempt(a.trim(),this));}}.bind(this));this.el.insertAtCursor(d.join("\r\n"),true);},getValue:function(){return this.el.get("value");},setValue:function(b){this.el.set("value",b);this.el.focus();},addFunction:function(l,j,h){var k=new Element("li");var i=new Element("a",{events:{click:function(a){a.stop();j.attempt(null,this);}.bind(this)},href:"#"});i.set("html","<span>"+l+"</span>");i.setProperties(h||{});i.inject(k,"bottom");k.inject(this.list,"inside");}});var _currentElement="";var _previewActive=false;function kToggleOrSwap(b){e=document.id(b);if(e){if(e.getStyle("display")=="none"){if(_currentElement!=""){_currentElement.setStyle("display","none");}e.setStyle("display","block");_currentElement=e;}else{e.setStyle("display","none");_currentElement="";}}}function kToggleOrSwapPreview(c){e=document.id("kbbcode-preview");f=document.id("kbbcode-message");if(e){if(e.getStyle("display")=="none"||e.getProperty("class")!=c){e.setStyle("display","block");if(c=="kbbcode-preview-right"){f.setStyle("width","47%");}else{f.setStyle("width","95%");}_previewActive=true;kPreviewHelper();}else{e.setStyle("display","none");f.setStyle("width","95%");_previewActive=false;}e.setProperty("class",c);var d=f.getStyle("height");e.setStyle("height",f.getStyle("height"));}}function kGenerateColorPalette(n,p){var l=0,m=0,b=0;var g=new Array(6);var o="";g[0]="00";g[1]="44";g[2]="88";g[3]="BB";g[4]="FF";document.writeln('<table id="kbbcode-colortable" class="kbbcode-colortable" cellspacing="1" cellpadding="0" border="0" style="width: 100%;">');for(l=0;l<5;l++){document.writeln("<tr>");for(m=0;m<5;m++){for(b=0;b<5;b++){o=String(g[l])+String(g[m])+String(g[b]);document.writeln('<td style="background-color:#'+o+"; width: "+n+"; height: "+p+';">&nbsp;</td>');}}document.writeln("</tr>");}document.writeln("</table>");}function kInsertCode(){var b="";if(document.id("kcodetype")!=undefined){b=document.id("kcodetype").get("value");}if(b!=""){b=" type="+b;}kbbcode.focus().wrapSelection("[code"+b+"]","[/code]",false);kToggleOrSwap("kbbcode-code-options");}function kInsertImageLink(){var b=document.id("kbbcode-image_size").get("value");if(b==""){kbbcode.focus().replaceSelection("[img]"+document.id("kbbcode-image_url").get("value")+"[/img]",false);}else{kbbcode.focus().replaceSelection("[img size="+b+"]"+document.id("kbbcode-image_url").get("value")+"[/img]",false);}kToggleOrSwap("kbbcode-image-options");}function kGrowShrinkMessage(j){var i=document.id("kbbcode-message");var k=document.id("kbbcode-preview");var h=parseInt(i.getStyle("height"));var l=h+j;if(l>100){i.setStyle("height",l+"px");k.setStyle("height",l+"px");}else{i.setStyle("height","100px");k.setStyle("height","100px");}}function myValidate(b){if(document.formvalidator.isValid(b)){return true;}return false;}function cancelForm(){document.forms.postform.action.value="cancel";return true;}var __attachment_limit=0;function setLimitOnEdit(){var b=$$("li.kattachment-old");if(b.length>0){__attachment_limit=b.length;}if(__attachment_limit==config_attachment_limit||__attachment_limit>config_attachment_limit){document.id("kattachment-id").setStyle("display","none");}}function newAttachment(){if(config_attachment_limit>0){if(__attachment_limit<config_attachment_limit){__attachment_limit++;}else{return false;}}var i=document.id("kattachment-id");if(!i){return;}i.setStyle("display","none");i.getElement("input").setProperty("value","");var g=i.retrieve("nextid",1);i.store("nextid",g+1);var j=i.clone().inject(i,"before").set("id","kattachment"+g).setStyle("display");j.getElement("span.kattachment-id-container").set("text",g+". ");var h=j.getElement("input.kfile-input").set("name","kattachment"+g).removeProperty("onchange");h.addEvent("change",function(){this.removeEvents("change");var a=this.get("value");if(a.lastIndexOf("\\")>-1){a=a.substring(1+a.lastIndexOf("\\"));}this.addEvent("change",function(){j.getElement("input.kfile-input-textbox").set("value",a);});j.getElement("input.kfile-input-textbox").set("value",a);j.getElement(".kattachment-insert").removeProperty("style").addEvent("click",function(){kbbcode.focus().insert("\n[attachment:"+g+"]"+a+"[/attachment]\n","after",false);return false;});j.getElement(".kattachment-remove").removeProperty("style").addEvent("click",function(){j.dispose();return false;});newAttachment();});}function bindAttachments(){var b=$$(".kattachment-old");if(!b){return;}b.each(function(a){a.getElement(".kattachment-insert").removeProperty("style").addEvent("click",function(){kbbcode.focus().insert("\n[attachment="+a.getElement('input[type="checkbox"]').get("value")+"]"+a.getElement(".kfilename").get("text")+"[/attachment]\n","after",false);return false;});});}function IEcompatibility(){if(Browser.ie){var b=$$("#kbbcode-size-options","#kbbcode-size-options span","#kbbcode-colortable","#kbbcode-colortable td");if(b){b.setProperty("unselectable","on");}}}Slick.definePseudo(this,function(b){return(this.selected&&this.get("tag")=="option");});function kInsertVideo1(){var k=document.id("kvideosize").get("value");var i=document.id("kvideowidth").get("value");if(i==""){i="425";}var l=document.id("kvideoheight").get("value");if(l==""){l="344";}var j=document.id("kvideoprovider").get("value");if(j==""){j="";}var h=document.id("kvideoid").get("value");kbbcode.focus().insert("[video"+(k?" size="+k:"")+" width="+i+" height="+l+" type="+j+"]"+h+"[/video]","after",false);kToggleOrSwap("kbbcode-video-options");}function kInsertVideo2(){var b=document.id("kvideourl").get("value");kbbcode.focus().insert("[video]"+b+"[/video]","after",false);kToggleOrSwap("kbbcode-video-options");}function kEditorInitialize(){$$("#kbbcode-toolbar li a").addEvent("mouseover",function(){document.id("helpbox").set("value",this.getProperty("alt"));});document.id("kbbcode-message").addEvent("change",function(){kPreviewHelper();});var d=$$("table.kbbcode-colortable td");if(d){d.addEvent("click",function(){var a=this.getStyle("background-color");kbbcode.focus().wrapSelection("[color="+a+"]","[/color]",true);kToggleOrSwap("kbbcode-color-options");});}var c=$$("div#kbbcode-size-options span");if(c){c.addEvent("click",function(){var a=this.get("title");kbbcode.focus().wrapSelection(a,"[/size]",true);kToggleOrSwap("kbbcode-size-options");});}bindAttachments();setLimitOnEdit();newAttachment();if(document.id("kvideoprovider")!=undefined){document.id("kvideoprovider").addEvent("change",function(){var a=$$("#kvideoprovider option:selected");a.each(function(b){document.id("kvideoprovider").store("videoprov",b.value);});});}IEcompatibility();}