/*! jquery.atwho - v0.4.12 - 2014-06-26
* Copyright (c) 2014 chord.luo <chord.luo@gmail.com>; 
* homepage: http://ichord.github.com/At.js 
* Licensed MIT
*/
(function(){(function(b){if(typeof define==="function"&&define.amd){return define(["jquery"],b);}else{return b(window.jQuery);}})(function(q){var t,o,s,m,r,n,l,u,v,p=[].slice;s=(function(){function a(b){this.current_flag=null;this.controllers={};this.alias_maps={};this.$inputor=q(b);this.iframe=null;this.setIframe();this.listen();}a.prototype.setIframe=function(d){var b;if(d){this.window=d.contentWindow;this.document=d.contentDocument||this.window.document;this.iframe=d;return this;}else{this.document=this.$inputor[0].ownerDocument;this.window=this.document.defaultView||this.document.parentWindow;try{return this.iframe=this.window.frameElement;}catch(c){b=c;}}};a.prototype.controller=function(b){var c,d,f,e;if(this.alias_maps[b]){d=this.controllers[this.alias_maps[b]];}else{e=this.controllers;for(f in e){c=e[f];if(f===b){d=c;break;}}}if(d){return d;}else{return this.controllers[this.current_flag];}};a.prototype.set_context_for=function(b){this.current_flag=b;return this;};a.prototype.reg=function(e,c){var b,d;b=(d=this.controllers)[e]||(d[e]=new r(this,e));if(c.alias){this.alias_maps[c.alias]=e;}b.init(c);return this;};a.prototype.listen=function(){return this.$inputor.on("keyup.atwhoInner",(function(b){return function(c){return b.on_keyup(c);};})(this)).on("keydown.atwhoInner",(function(b){return function(c){return b.on_keydown(c);};})(this)).on("scroll.atwhoInner",(function(b){return function(c){var d;return(d=b.controller())!=null?d.view.hide(c):void 0;};})(this)).on("blur.atwhoInner",(function(b){return function(d){var c;if(c=b.controller()){return c.view.hide(d,c.get_opt("display_timeout"));}};})(this));};a.prototype.shutdown=function(){var c,b,d;d=this.controllers;for(b in d){c=d[b];c.destroy();delete this.controllers[b];}return this.$inputor.off(".atwhoInner");};a.prototype.dispatch=function(){return q.map(this.controllers,(function(b){return function(c){var d;if(d=c.get_opt("delay")){clearTimeout(b.delayedCallback);return b.delayedCallback=setTimeout(function(){if(c.look_up()){return b.set_context_for(c.at);}},d);}else{if(c.look_up()){return b.set_context_for(c.at);}}};})(this));};a.prototype.on_keyup=function(c){var b;switch(c.keyCode){case l.ESC:c.preventDefault();if((b=this.controller())!=null){b.view.hide();}break;case l.DOWN:case l.UP:case l.CTRL:q.noop();break;case l.P:case l.N:if(!c.ctrlKey){this.dispatch();}break;default:this.dispatch();}};a.prototype.on_keydown=function(c){var b,d;b=(d=this.controller())!=null?d.view:void 0;if(!(b&&b.visible())){return;}switch(c.keyCode){case l.ESC:c.preventDefault();b.hide(c);break;case l.UP:c.preventDefault();b.prev();break;case l.DOWN:c.preventDefault();b.next();break;case l.P:if(!c.ctrlKey){return;}c.preventDefault();b.prev();break;case l.N:if(!c.ctrlKey){return;}c.preventDefault();b.next();break;case l.TAB:case l.ENTER:if(!b.visible()){return;}c.preventDefault();b.choosing=true;b.choose(c);break;default:q.noop();}};return a;})();r=(function(){a.prototype.uid=function(){return(Math.random().toString(16)+"000000000").substr(2,8)+(new Date().getTime());};function a(c,b){this.app=c;this.at=b;this.$inputor=this.app.$inputor;this.id=this.$inputor[0].id||this.uid();this.setting=null;this.query=null;this.pos=0;this.cur_rect=null;this.range=null;t.append(this.$el=q("<div id='atwho-ground-"+this.id+"'></div>"));this.model=new u(this);this.view=new v(this);}a.prototype.init=function(b){this.setting=q.extend({},this.setting||q.fn.atwho["default"],b);this.view.init();return this.model.reload(this.setting.data);};a.prototype.destroy=function(){this.trigger("beforeDestroy");this.model.destroy();this.view.destroy();return this.$el.remove();};a.prototype.call_default=function(){var d,e,b;b=arguments[0],d=2<=arguments.length?p.call(arguments,1):[];try{return n[b].apply(this,d);}catch(c){e=c;return q.error(""+e+" Or maybe At.js doesn't have function "+b);}};a.prototype.trigger=function(b,d){var e,c;if(d==null){d=[];}d.push(this);e=this.get_opt("alias");c=e?""+b+"-"+e+".atwho":""+b+".atwho";return this.$inputor.trigger(c,d);};a.prototype.callbacks=function(b){return this.get_opt("callbacks")[b]||n[b];};a.prototype.get_opt=function(e,b){var d;try{return this.setting[e];}catch(c){d=c;return null;}};a.prototype.content=function(){if(this.$inputor.is("textarea, input")){return this.$inputor.val();}else{return this.$inputor.text();}};a.prototype.catch_query=function(){var b,e,g,d,c,f;e=this.content();b=this.$inputor.caret("pos");f=e.slice(0,b);d=this.callbacks("matcher").call(this,this.at,f,this.get_opt("start_with_space"));if(typeof d==="string"&&d.length<=this.get_opt("max_len",20)){c=b-d.length;g=c+d.length;this.pos=c;d={text:d,head_pos:c,end_pos:g};this.trigger("matched",[this.at,d.text]);}else{d=null;this.view.hide();}return this.query=d;};a.prototype.rect=function(){var c,b;if(!(c=this.$inputor.caret({iframe:this.app.iframe}).caret("offset",this.pos-1))){return;}if(this.$inputor.attr("contentEditable")==="true"){c=(this.cur_rect||(this.cur_rect=c))||c;}b=this.app.document.selection?0:2;return{left:c.left,top:c.top,bottom:c.top+c.height+b};};a.prototype.reset_rect=function(){if(this.$inputor.attr("contentEditable")==="true"){return this.cur_rect=null;}};a.prototype.mark_range=function(){if(this.$inputor.attr("contentEditable")==="true"){if(this.app.window.getSelection){this.range=this.app.window.getSelection().getRangeAt(0);}if(this.app.document.selection){return this.ie8_range=this.app.document.selection.createRange();}}};a.prototype.insert_content_for=function(c){var d,e,b;e=c.data("value");b=this.get_opt("insert_tpl");if(this.$inputor.is("textarea, input")||!b){return e;}d=q.extend({},c.data("item-data"),{"atwho-data-value":e,"atwho-at":this.at});return this.callbacks("tpl_eval").call(this,b,d);};a.prototype.insert=function(B,z){var j,i,d,f,A,k,b,e,g,c,h;j=this.$inputor;if(j.attr("contentEditable")==="true"){d="atwho-view-flag atwho-view-flag-"+(this.get_opt("alias")||this.at);f=""+B+"<span contenteditable='false'>&nbsp;<span>";A="<span contenteditable='false' class='"+d+"'>"+f+"</span>";i=q(A,this.app.document).data("atwho-data-item",z.data("item-data"));if(this.app.document.selection){i=q("<span contenteditable='true'></span>",this.app.document).html(i);}}if(j.is("textarea, input")){B=this.get_opt("space_after")?B+" ":""+B;g=j.val();c=g.slice(0,Math.max(this.query.head_pos-this.at.length,0));h=""+c+B+(g.slice(this.query.end_pos||0));j.val(h);j.caret("pos",c.length+B.length);}else{if(b=this.range){k=b.startOffset-(this.query.end_pos-this.query.head_pos)-this.at.length;b.setStart(b.endContainer,Math.max(k,0));b.setEnd(b.endContainer,b.endOffset);b.deleteContents();b.insertNode(i[0]);b.collapse(false);e=this.app.window.getSelection();e.removeAllRanges();e.addRange(b);}else{if(b=this.ie8_range){b.moveStart("character",this.query.end_pos-this.query.head_pos-this.at.length);b.pasteHTML(f);b.collapse(false);b.select();}}}if(!j.is(":focus")){j.focus();}return j.change();};a.prototype.render_view=function(c){var b;b=this.get_opt("search_key");c=this.callbacks("sorter").call(this,this.query.text,c.slice(0,1001),b);return this.view.render(c.slice(0,this.get_opt("limit")));};a.prototype.look_up=function(){var c,b;if(!(c=this.catch_query())){return;}b=function(d){if(d&&d.length>0){return this.render_view(d);}else{return this.view.hide();}};this.model.query(c.text,q.proxy(b,this));return c;};return a;})();u=(function(){function a(b){this.context=b;this.at=this.context.at;this.storage=this.context.$inputor;}a.prototype.destroy=function(){return this.storage.data(this.at,null);};a.prototype.saved=function(){return this.fetch()>0;};a.prototype.query=function(e,c){var f,b,d;f=this.fetch();b=this.context.get_opt("search_key");f=this.context.callbacks("filter").call(this.context,e,f,b)||[];d=this.context.callbacks("remote_filter");if(f.length>0||(!d&&f.length===0)){return c(f);}else{return d.call(this.context,e,c);}};a.prototype.fetch=function(){return this.storage.data(this.at)||[];};a.prototype.save=function(b){return this.storage.data(this.at,this.context.callbacks("before_save").call(this.context,b||[]));};a.prototype.load=function(b){if(!(this.saved()||!b)){return this._load(b);}};a.prototype.reload=function(b){return this._load(b);};a.prototype._load=function(b){if(typeof b==="string"){return q.ajax(b,{dataType:"json"}).done((function(c){return function(d){return c.save(d);};})(this));}else{return this.save(b);}};return a;})();v=(function(){function a(b){this.context=b;this.$el=q("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>");this.timeout_id=null;this.context.$el.append(this.$el);this.bind_event();}a.prototype.init=function(){var b;b=this.context.get_opt("alias")||this.context.at.charCodeAt(0);return this.$el.attr({id:"at-view-"+b});};a.prototype.destroy=function(){return this.$el.remove();};a.prototype.bind_event=function(){var b;b=this.$el.find("ul");return b.on("mouseenter.atwho-view","li",function(c){b.find(".cur").removeClass("cur");return q(c.currentTarget).addClass("cur");}).on("click",(function(c){return function(d){c.choose(d);return d.preventDefault();};})(this));};a.prototype.visible=function(){return this.$el.is(":visible");};a.prototype.choose=function(d){var c,b;if((c=this.$el.find(".cur")).length){b=this.context.insert_content_for(c);this.context.insert(this.context.callbacks("before_insert").call(this.context,b,c),c);this.context.trigger("inserted",[c,d]);return this.hide(d);}};a.prototype.reposition=function(b){var c,d;if(b.bottom+this.$el.height()-q(window).scrollTop()>q(window).height()){b.bottom=b.top-this.$el.height();}c={left:b.left,top:b.bottom};if((d=this.context.callbacks("before_reposition"))!=null){d.call(this.context,c);}this.$el.offset(c);return this.context.trigger("reposition",[c]);};a.prototype.next=function(){var c,b;c=this.$el.find(".cur").removeClass("cur");b=c.next();if(!b.length){b=this.$el.find("li:first");}return b.addClass("cur");};a.prototype.prev=function(){var c,b;c=this.$el.find(".cur").removeClass("cur");b=c.prev();if(!b.length){b=this.$el.find("li:last");}return b.addClass("cur");};a.prototype.show=function(){var b;if(this.choosing){this.choosing=false;return;}this.context.mark_range();if(!this.visible()){this.$el.show();this.context.trigger("shown");}if(b=this.context.rect()){return this.reposition(b);}};a.prototype.hide=function(d,b){var c;if(!this.visible()){return;}if(isNaN(b)){this.context.reset_rect();this.$el.hide();return this.context.trigger("hidden",[d]);}else{c=(function(e){return function(){return e.hide();};})(this);clearTimeout(this.timeout_id);return this.timeout_id=setTimeout(c,b);}};a.prototype.render=function(d){var c,g,f,b,h,e,i;if(!(q.isArray(d)&&d.length>0)){this.hide();return;}this.$el.find("ul").empty();g=this.$el.find("ul");h=this.context.get_opt("tpl");for(e=0,i=d.length;e<i;e++){f=d[e];f=q.extend({},f,{"atwho-at":this.context.at});b=this.context.callbacks("tpl_eval").call(this.context,h,f);c=q(this.context.callbacks("highlighter").call(this.context,b,this.context.query.text));c.data("item-data",f);g.append(c);}this.show();if(this.context.get_opt("highlight_first")){return g.find("li:first").addClass("cur");}};return a;})();l={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13,CTRL:17,P:80,N:78};n={before_save:function(c){var e,d,a,b;if(!q.isArray(c)){return c;}b=[];for(d=0,a=c.length;d<a;d++){e=c[d];if(q.isPlainObject(e)){b.push(e);}else{b.push({name:e});}}return b;},matcher:function(a,d,b){var e,c;a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");if(b){a="(?:^|\\s)"+a;}c=new RegExp(a+"([A-Za-z0-9_+-]*)$|"+a+"([^\\x00-\\xff]*)$","gi");e=c.exec(d);if(e){return e[2]||e[1];}else{return null;}},filter:function(c,d,f){var g,e,a,b;b=[];for(e=0,a=d.length;e<a;e++){g=d[e];if(~g[f].toLowerCase().indexOf(c.toLowerCase())){b.push(g);}}return b;},remote_filter:null,sorter:function(c,g,e){var f,d,a,b;if(!c){return g;}b=[];for(d=0,a=g.length;d<a;d++){f=g[d];f.atwho_order=f[e].toLowerCase().indexOf(c.toLowerCase());if(f.atwho_order>-1){b.push(f);}}return b.sort(function(h,i){return h.atwho_order-i.atwho_order;});},tpl_eval:function(a,d){var b;try{return a.replace(/\$\{([^\}]*)\}/g,function(g,f,e){return d[f];});}catch(c){b=c;return"";}},highlighter:function(b,c){var a;if(!c){return b;}a=new RegExp(">\\s*(\\w*?)("+c.replace("+","\\+")+")(\\w*)\\s*<","ig");return b.replace(a,function(e,g,d,f){return"> "+g+"<strong>"+d+"</strong>"+f+" <";});},before_insert:function(b,a){return b;}};o={load:function(b,a){var c;if(c=this.controller(b)){return c.model.load(a);}},getInsertedItemsWithIDs:function(b){var c,d,a;if(!(c=this.controller(b))){return[null,null];}if(b){b="-"+(c.get_opt("alias")||c.at);}d=[];a=q.map(this.$inputor.find("span.atwho-view-flag"+(b||"")),function(f){var e;e=q(f).data("atwho-data-item");if(d.indexOf(e.id)>-1){return;}if(e.id){d.push=e.id;}return e;});return[d,a];},getInsertedItems:function(a){return o.getInsertedItemsWithIDs.apply(this,[a])[1];},getInsertedIDs:function(a){return o.getInsertedItemsWithIDs.apply(this,[a])[0];},setIframe:function(a){return this.setIframe(a);},run:function(){return this.dispatch();},destroy:function(){this.shutdown();return this.$inputor.data("atwho",null);}};m={init:function(b){var a,c;c=(a=q(this)).data("atwho");if(!c){a.data("atwho",(c=new s(this)));}c.reg(b.at,b);return this;}};t=q("<div id='atwho-container'></div>");q.fn.atwho=function(c){var b,a;a=arguments;q("body").append(t);b=null;this.filter("textarea, input, [contenteditable=true]").each(function(){var d;if(typeof c==="object"||!c){return m.init.apply(this,a);}else{if(o[c]){if(d=q(this).data("atwho")){return b=o[c].apply(d,Array.prototype.slice.call(a,1));}}else{return q.error("Method "+c+" does not exist on jQuery.caret");}}});return b||this;};q.fn.atwho["default"]={at:void 0,alias:void 0,space_after:true,data:null,tpl:"<li data-value='${atwho-at}${name}'>${name}</li>",insert_tpl:"<span>${atwho-data-value}</span>",callbacks:n,search_key:"name",start_with_space:true,highlight_first:true,limit:5,max_len:20,display_timeout:300,delay:null};});}).call(this);